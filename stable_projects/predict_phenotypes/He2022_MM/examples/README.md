# Code for Meta-matching examples

----

## References
+ He, T., An, L., Feng, J., Bzdok, D., Eickhoff, S.B. and Yeo, B.T., 2020. [**Meta-matching: a simple approach to leverage large-scale brain imaging datasets to boost prediction of non-imaging phenotypes in small datasets**](https://doi.org/10.1101/2020.08.10.245373), under review.

----

## Usage

### 1. Generate fake data
In this example, we use fake data generated by following code:
```bash
cd $CBIG_CODE_DIR/stable_projects/predict_phenotypes/He2022_MM/examples
python3 data_generate.py
# python3 data_generate.py -d unit_tests
```

### 2. Classical KRR
Run the classical KRR:
```matlab
CBIG_CODE_DIR = getenv('CBIG_CODE_DIR');
base_dir = fullfile(CBIG_CODE_DIR, 'stable_projects', 'predict_phenotypes', 'He2022_MM');
example_dir = fullfile(base_dir, 'examples');
cd(example_dir);

code_dir = fullfile(base_dir, 'KRR_CLASSICAL');
input_dir = fullfile(example_dir, 'exp_input');
output_dir = fullfile(example_dir, 'exp_output', 'output_KRR_classical_exp');
subj_list = fullfile(input_dir, 'exp_test_subj_list.txt');
phe_csv = fullfile(input_dir, 'exp_test_final.csv');
FC_file = fullfile(input_dir, 'exp_test_pfc.mat');
phe_list = fullfile(input_dir, 'exp_test_final_phe_list.txt');
temp = textscan(fopen(phe_list), '%s');
phes = temp{1};
ks = {'10', '20', '50', '100', '200'};
rngs_num = 3; % run the Classical KRR 3 times with 3 different split of K shot

addpath(code_dir);
for i = 1:length(phes)
    for j = 1:length(ks)
        CBIG_MM_KRR_classical(CBIG_CODE_DIR, subj_list, phe_csv, FC_file, output_dir, rngs_num, phes{i}, ks{j}, false);
    end
end

% After KRR classical in previous section finished, run following code to get result summary:
CBIG_MM_KRR_classical_summary(CBIG_CODE_DIR, output_dir, phe_list, rngs_num, 'exp')

% Check the result by
result_file = fullfile(output_dir, 'final_result', 'krr_classical_res_test.mat');
result = load(result_file);
disp(squeeze(mean(mean(result.meta_cor, 2), 1)))
% reference disp result:    0.2365    0.2961    0.4295    0.5661    0.7332
% average correlation for K = 10        20        50        100       200
disp(squeeze(mean(mean(result.meta_cod, 2), 1)))
% reference disp result:    0.0281    0.0373    0.1074    0.3011    0.5183
% average COD for         K = 10        20        50        100       200
```
You can check the result you got against the result with the one in `exp_output\output_KRR_classical_exp` folder.


### 3. KRR Meta-matching
Run the KRR meta-matching by:
```matlab
CBIG_CODE_DIR = getenv('CBIG_CODE_DIR');
base_dir = fullfile(CBIG_CODE_DIR, 'stable_projects', 'predict_phenotypes', 'He2022_MM');
example_dir = fullfile(base_dir, 'examples');
cd(example_dir);

code_dir = fullfile(base_dir, 'KRR_MM');
input_dir = fullfile(example_dir, 'exp_input');
output_dir = fullfile(example_dir, 'exp_output', 'output_KRR_mm');
phe_list = fullfile(input_dir, 'exp_train_final_phe_list.txt');
phe_csv = fullfile(input_dir, 'exp_train_test_final.csv');
subj_list = fullfile(input_dir, 'exp_train_test_subj_list.txt');
fc_mat = fullfile(input_dir, 'exp_train_test_pfc.mat');
subj_list_train = fullfile(input_dir, 'exp_train_subj_list.txt');
subj_list_extra = fullfile(input_dir, 'exp_test_subj_list.txt');

rngs_num = 1; % run the KRR MM base 1 times

addpath(code_dir);
for rng_num = 1:rngs_num
    CBIG_MM_KRR_MM_base(CBIG_CODE_DIR, subj_list, phe_csv, fc_mat, output_dir, num2str(rng_num), phe_list, subj_list_train, subj_list_extra);
end

% Run the KRR meta-matching by (Make sure you have run the KRR classical, KRR meta-matching need the split files for K shot):
krr_classical_dir = fullfile(example_dir, 'exp_output', 'output_KRR_classical_exp');
mm_rng_nums = 3;
prefix = 'exp';
CBIG_MM_KRR_MM_summary(CBIG_CODE_DIR, base_dir, output_dir, krr_classical_dir, input_dir, mm_rng_nums, prefix)

% Check result for KRR meta-matching
result_file = fullfile(output_dir, 'meta_result', 'meta_res_test.mat');
result = load(result_file);
disp(squeeze(mean(mean(result.meta_cor, 2), 1)))
% reference disp result:    0.6689    0.6714    0.6979    0.7264    0.7324
% average correlation for K = 10        20        50        100       200
disp(squeeze(mean(mean(result.meta_cod, 2), 1)))
% reference disp result:    0.2324    0.3138    0.4310    0.4963    0.5166
% average COD for         K = 10        20        50        100       200
```

### 4. Run DNN

The DNN meta-matching uses the split from KRR classical and meta-matching, if you want to run it, you need to run following command to get the split:
```bash
cd $CBIG_CODE_DIR/stable_projects/predict_phenotypes/He2022_MM/examples
python3 ../cbig/He2022/get_split.py -d exp
```

Run following code below. The base model training and advanced meta-matching DNN finetune need GPU to run, or you may want to modify the code to use CPU only. You can check the comment for the reference result. Please note, this is just a generated data, please refer to the `He2022_MM/replication` folder for the performance on real dataset. 

```bash
base_dir=$CBIG_CODE_DIR/stable_projects/predict_phenotypes/He2022_MM/examples
cd $base_dir
input_dir=$base_dir/exp_input
intermediate_dir=$base_dir/exp_output/output_intermediate
output_dir=$base_dir/exp_output/output_dnn

# base model training
python ../cbig/He2022/CBIG_ukbb_dnn.py --exp-dataset --in_dir $input_dir --out_dir $output_dir \
--inter_dir $intermediate_dir --gpu 0 --seed 1 --epochs 1000 --metric cod \
--weight_decay 8.447320e-04 --lr 3.645653e-03 --dropout 0.241964 --scheduler_decrease 312 \
--n_l1 87 --n_l2 386 --n_l3 313 --n_l4 349 --n_layer 4
# Best validation at index:  864
# Average validation corr: 0.9356519941311241 , COD: 0.7996754005543218 , MAE: 126.73842307178165

# Basic meta-matching DNN
python3 ../cbig/He2022/CBIG_ukbb_dnn_mm.py --exp-dataset --in_dir $input_dir --out_dir $output_dir \
--inter_dir $intermediate_dir --rng 3
# rng 2 at 0.24660396575927734s: cor 0.83329, cod 0.66202
# 0.818702 0.822966 0.836951 0.843549 0.844259  COD  0.630635 0.647320 0.671728 0.682038 0.678399

# Advanced meta-matching DNN stacking with restricted-alpha
python3 ../cbig/He2022/CBIG_ukbb_dnn_mm_stacking.py --exp-dataset --in_dir $input_dir --out_dir $output_dir \
--inter_dir $intermediate_dir --rng 3 --restricted-alpha
# rng 2 at 5.953491687774658s: cor 0.24219, cod 0.06978
# 0.046614 0.082461 0.244200 0.368944 0.468754  COD  -0.004174 0.005956 0.052669 0.113945 0.180483

# Advanced meta-matching DNN stacking with full set of alpha
python3 ../cbig/He2022/CBIG_ukbb_dnn_mm_stacking.py --exp-dataset --in_dir $input_dir --out_dir $output_dir \
--inter_dir $intermediate_dir --rng 3 --not-restricted-alpha
# rng 2 at 28.897029876708984s: cor 0.45633, cod 0.13727
# 0.045540 0.092036 0.570921 0.770114 0.803039  COD  -0.758338 -0.033242 0.267363 0.570382 0.640185

# Advanced meta-matching DNN finetune
python3 ../cbig/He2022/CBIG_ukbb_dnn_mm_finetune.py --gpu 0 --exp-dataset --in_dir $input_dir --out_dir $output_dir \
--inter_dir $intermediate_dir --rng 3
# rng 2 at 8126.544145584106s: cor 0.83329, tuned 0.83773, cod 0.66202, tuned 0.66151
# 0.808542 0.819708 0.842375 0.852880 0.865138  COD  0.604202 0.634890 0.676690 0.695644 0.696116
```

----

## Bugs and Questions
Please contact Tong He at hetong1115@gmail.com, Lijun An at anlijun.cn@gmail.com and Pansheng Chen at chenpansheng@gmail.com.
